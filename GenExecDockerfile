FROM drydock/microbase:{{%TAG%}}

# add common package.json and entrypoint
ADD ./nod/package.json /home/shippable/micro/nod/package.json
ADD ./nod/boot.sh /home/shippable/micro/nod/boot.sh

RUN cd /home/shippable/micro/nod && npm install

# shippable global utils
ADD ./nod/_global /home/shippable/micro/nod/_global

# add main microservice directory
ADD ./nod/genExec /home/shippable/micro/nod/genExec

ENV EXEC_TEMPLATES_PATH /home/shippable/execTemplates
RUN mkdir -p $EXEC_TEMPLATES_PATH && \
    wget https://github.com/Shippable/execTemplates/archive/{{%TAG%}}.tar.gz -O /tmp/execTemplates.tar.gz && \
    tar -xzvf /tmp/execTemplates.tar.gz -C $EXEC_TEMPLATES_PATH --strip-components=1 && \
    rm /tmp/execTemplates.tar.gz

ENTRYPOINT ["/home/shippable/micro/nod/boot.sh"]
